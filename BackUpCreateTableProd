import mysql.connector
import os
from datetime import datetime

# Diret√≥rio onde os arquivos ser√£o salvos
BACKUP_DIR = r'\\omega\GECOP\RESULTADOS\06. BackUp CREATE TABLE MYSQL (172.25.100.14)'

# Conex√£o com o MySQL
conn = mysql.connector.connect(
    host='172.25.100.14',
    user='fecsantos',
    password='@Fec13022025'
)
cursor = conn.cursor()

# Data e hora no formato AAAA-MM-DD_HHMM
timestamp_str = datetime.now().strftime('%Y-%m-%d_%H%M')

# Buscar todos os bancos de dados
cursor.execute("SHOW DATABASES")
databases = [row[0] for row in cursor.fetchall()]

# Ignorar bancos do sistema
system_dbs = {'information_schema', 'mysql', 'performance_schema', 'sys'}

for db in databases:
    if db in system_dbs:
        continue

    print(f"\nüìÅ Processando banco: {db}")
    
    # Criar diret√≥rio por banco
    db_dir = os.path.join(BACKUP_DIR, db)
    os.makedirs(db_dir, exist_ok=True)

    # Mudar para o banco atual
    cursor.execute(f"USE `{db}`")

    # Buscar tabelas
    cursor.execute("SHOW TABLES")
    tables = [row[0] for row in cursor.fetchall()]
    print(f"üîç Encontradas {len(tables)} tabelas no banco {db}")

    for table_name in tables:
        print(f"   - Exportando tabela: {table_name}")
        
        try:
            cursor.execute(f"SHOW CREATE TABLE `{table_name}`")
            result = cursor.fetchone()
            
            if result:
                definition = result[1]  # O CREATE TABLE est√° na segunda posi√ß√£o

                # Nome e caminho do arquivo com data e hora
                filename = f"{table_name}_{timestamp_str}.txt"
                filepath = os.path.join(db_dir, filename)

                with open(filepath, 'w', encoding='utf-8') as f:
                    f.write(definition)
                
                print(f"     ‚úî Tabela {table_name} salva com sucesso.")
        except Exception as e:
            print(f"     ‚ùå Erro ao obter defini√ß√£o da tabela {table_name}: {e}")

# Encerrar conex√£o
cursor.close()
conn.close()

print("\n‚úÖ Backup das tabelas conclu√≠do.")
